<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Just Wanna Lift</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            font-size: 18px;
            line-height: 1.6;
            color: #1a1a1a;
            background: #fafafa;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 32px;
            text-align: center;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #000;
        }

        .user-name {
            font-size: 18px;
            color: #666;
            font-weight: 400;
        }

        .day-section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .day-section.preview {
            opacity: 0.6;
        }

        .day-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
            color: #000;
        }

        .rest-day {
            text-align: center;
            font-size: 28px;
            font-weight: 600;
            color: #666;
            padding: 40px 0;
        }

        .lift {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .lift:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .lift-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #000;
        }

        .lift-sets-reps {
            font-size: 16px;
            color: #666;
            margin-bottom: 4px;
        }

        .lift-weight {
            font-size: 18px;
            color: #333;
            margin-bottom: 4px;
        }

        .lift-plates {
            font-size: 16px;
            color: #666;
        }

        .deload-indicator {
            display: inline-block;
            background: #ff9800;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 8px;
        }

        .plate-chip {
            display: inline-block;
            padding: 2px 8px;
            margin: 2px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #f5f5f5;
            font-size: 14px;
            color: #333;
        }

        .stats-table {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-x: auto;
        }

        .stats-table h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #000;
        }

        .stats-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .stats-table th {
            background: #f5f5f5;
            padding: 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
        }

        .stats-table td {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .stats-table tr:last-child td {
            border-bottom: none;
        }

        .percentage-positive {
            color: #2e7d32;
            font-weight: 600;
        }

        .settings-section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .settings-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #000;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-toggle {
            font-size: 16px;
            color: #666;
        }

        .settings-content {
            display: none;
        }

        .settings-content.open {
            display: block;
        }

        .settings-group {
            margin-bottom: 24px;
        }

        .settings-group h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        .setting-field {
            margin-bottom: 16px;
        }

        .setting-field label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .setting-hint {
            font-size: 12px;
            color: #666;
            font-weight: 400;
            margin-left: 4px;
        }

        .setting-field input[type="text"],
        .setting-field input[type="number"],
        .setting-field input[type="date"] {
            width: 100%;
            padding: 8px 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
        }

        .setting-field input.invalid {
            border-color: #d32f2f;
            background: #ffebee;
        }

        .setting-error {
            color: #d32f2f;
            font-size: 12px;
            margin-top: 4px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            font-size: 14px;
            cursor: pointer;
            margin: 0;
        }

        .reset-button {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 16px;
            margin-right: 12px;
        }

        .reset-button:hover {
            background: #b71c1c;
        }

        .save-button {
            background: #2e7d32;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 16px;
        }

        .save-button:hover {
            background: #1b5e20;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .error-banner {
            background: #ffebee;
            border: 2px solid #d32f2f;
            color: #d32f2f;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            font-weight: 600;
        }

        .footer {
            text-align: center;
            padding: 24px;
            color: #666;
            font-size: 14px;
        }

        .footer a {
            color: #2e7d32;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 428px) {
            body {
                padding: 16px;
                font-size: 17px;
            }

            h1 {
                font-size: 22px;
            }

            .day-section {
                padding: 20px;
                margin-bottom: 20px;
            }

            .day-header {
                font-size: 18px;
            }

            .lift-name {
                font-size: 19px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1 id="header"></h1>
    </header>

    <div id="app"></div>

    <script type="application/json" id="program-config">
    {
      "user": {
        "name": "Stephen",
        "bodyweight_lb": 175,
        "start_date": "2025-09-15",
        "total_weeks": 52,
        "training_days": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]
      },
      "bar_weight_lb": 45,
      "rep_scheme": {
        "Squat": [5],
        "Overhead Press": [5, 6, 5, 7, 5, 6, 5, 8],
        "Pullup": [5, 6, 5, 7, 5, 6, 5, 8],
        "Deadlift": [5],
        "Bench": [5, 6, 5, 7, 5, 6, 5, 8],
        "Row": [5, 6, 5, 7, 5, 6, 5, 8]
      },
      "schedule": {
        "pattern": {
          "A": ["Squat", "Overhead Press", "Pullup"],
          "B": ["Deadlift", "Bench", "Row"]
        },
        "cycle": ["A", "B"]
      },
      "sets_reps": {
        "Squat":   {"sets": 2},
        "Deadlift":{"sets": 2},
        "Overhead Press":{"sets": 3},
        "Bench":  {"sets": 3},
        "Row":    {"sets": 3},
        "Pullup": {"sets": 3, "type": "weighted_bodyweight"} 
      },
      "round_plates_per_side_to_lb": {
        "Squat": 1.25, 
        "Deadlift": 1.25, 
        "Overhead Press": 0.25, 
        "Bench": 0.25, 
        "Row": 0.25, 
        "Pullup": 1.25
      },
      "progression": {
        "alpha": 0.0105,
        "deload_every_weeks": 8,
        "deload_factor": 0.82
      },
      "targets": {
        "goal_bodyweight_multiple": {
          "Squat": 1.60,
          "Overhead Press": 0.65,
          "Pullup": 1.30,
          "Deadlift": 2.00,
          "Bench": 1.15,
          "Row": 0.85
        },
        "start_as_percentage_of_goal": {
          "Squat": 0.50,
          "Overhead Press": 0.50,
          "Pullup": 0.769,
          "Deadlift": 0.50,
          "Bench": 0.40,
          "Row": 0.60
        }
      },
      "plate_inventory_per_side_lb": [45, 25, 10, 5, 2.5, 1.25, 1, 0.75, 0.5, 0.25]
    }
    </script>

    <script>
        // Get default configuration from embedded JSON
        function getDefaultConfig() {
            const configEl = document.getElementById('program-config');
            return JSON.parse(configEl.textContent);
        }

        // LocalStorage persistence
        const STORAGE_KEY = 'workout-config';
        const COLLAPSE_KEY = 'workout-settings-collapsed';

        function saveConfig(config) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
                return true;
            } catch (e) {
                console.error('Failed to save config:', e);
                return false;
            }
        }

        function loadConfig() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.error('Failed to load config:', e);
            }
            return getDefaultConfig();
        }

        // Validation
        function validateConfig(config) {
            const errors = [];
            
            // User validation
            if (!config.user.name || config.user.name.trim() === '') {
                errors.push({ field: 'name', message: 'Name is required' });
            }
            if (!config.user.bodyweight_lb || config.user.bodyweight_lb <= 0) {
                errors.push({ field: 'bodyweight_lb', message: 'Bodyweight must be positive' });
            }
            if (!config.user.start_date || !/^\d{4}-\d{2}-\d{2}$/.test(config.user.start_date)) {
                errors.push({ field: 'start_date', message: 'Invalid date format (use YYYY-MM-DD)' });
            }
            
            // Training days validation
            if (!config.user.training_days || config.user.training_days.length === 0) {
                errors.push({ field: 'training_days', message: 'At least one training day required' });
            }
            
            // Rep scheme validation
            const lifts = ['Squat', 'Overhead Press', 'Pullup', 'Deadlift', 'Bench', 'Row'];
            lifts.forEach(lift => {
                const repArray = config.rep_scheme[lift];
                if (!Array.isArray(repArray) || repArray.length === 0) {
                    errors.push({ field: `reps_${lift}`, message: `${lift} rep pattern must be a non-empty array` });
                } else {
                    const hasInvalid = repArray.some(r => typeof r !== 'number' || r <= 0 || r > 50);
                    if (hasInvalid) {
                        errors.push({ field: `reps_${lift}`, message: `${lift} reps must be positive numbers (1-50)` });
                    }
                }
            });
            
            // Goal multiples validation (using lifts from above)
            lifts.forEach(lift => {
                const goal = config.targets.goal_bodyweight_multiple[lift];
                if (goal === undefined || goal <= 0) {
                    errors.push({ field: `goal_${lift}`, message: `${lift} goal must be positive` });
                }
                
                const start = config.targets.start_as_percentage_of_goal[lift];
                if (start === undefined || start < 0 || start > 1) {
                    errors.push({ field: `start_${lift}`, message: `${lift} start must be between 0 and 1` });
                }
            });
            
            // Plate inventory validation
            if (!Array.isArray(config.plate_inventory_per_side_lb) || config.plate_inventory_per_side_lb.length === 0) {
                errors.push({ field: 'plate_inventory', message: 'Plate inventory must be a non-empty array' });
            } else {
                const hasInvalid = config.plate_inventory_per_side_lb.some(p => typeof p !== 'number' || p <= 0);
                if (hasInvalid) {
                    errors.push({ field: 'plate_inventory', message: 'All plates must be positive numbers' });
                }
            }
            
            // Progression validation
            if (!config.progression.alpha || config.progression.alpha <= 0) {
                errors.push({ field: 'alpha', message: 'Alpha must be positive' });
            }
            if (!config.progression.deload_factor || config.progression.deload_factor <= 0 || config.progression.deload_factor > 1) {
                errors.push({ field: 'deload_factor', message: 'Deload factor must be between 0 and 1' });
            }
            
            return errors;
        }

        // Initialize config from localStorage or defaults
        let config = loadConfig();
        let workingConfig = JSON.parse(JSON.stringify(config)); // Working copy for edits

        // Date utilities
        function parseDate(dateStr) {
            return new Date(dateStr + 'T00:00:00');
        }

        function formatDate(date) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
        }

        function getDaysElapsed(startDate, currentDate) {
            const start = parseDate(startDate);
            const current = parseDate(currentDate);
            const diffTime = current - start;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function isTrainingDayISO(iso) {
            const d = parseDate(iso);
            const name = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][d.getDay()];
            return config.user.training_days.includes(name);
        }

        function isRestDayISO(iso) {
            return !isTrainingDayISO(iso);
        }

        function getTrainingDayNumber(startDate, currentDate) {
            const start = parseDate(startDate);
            const current = parseDate(currentDate);
            
            let trainingDays = 0;
            let date = new Date(start);
            
            while (date <= current) {
                const dateISO = formatDateISO(date);
                if (isTrainingDayISO(dateISO)) {
                    trainingDays++;
                }
                date.setDate(date.getDate() + 1);
            }
            
            return trainingDays;
        }

        function getCyclePosition(trainingDayNumber) {
            return (trainingDayNumber - 1) % 2;
        }

        function getWeekNumber(daysElapsed) {
            return Math.floor(daysElapsed / 7) + 1;
        }

        function isDeloadWeek(daysElapsed) {
            // Deload every 56 days (8 weeks)
            // Week 9 starts at day 56 (deload week)
            // Check if we've crossed a 56-day boundary this week
            if (daysElapsed < 7) return false; // First week can't be deload
            return Math.floor(daysElapsed / 56) > Math.floor((daysElapsed - 7) / 56);
        }

        function getRepsForExercise(lift, trainingDayNumber) {
            const repArray = config.rep_scheme[lift];
            if (!repArray || repArray.length === 0) {
                return 5; // Fallback default
            }
            // Use modulo to cycle through the array
            // trainingDayNumber is 1-indexed, so subtract 1 for 0-indexed array
            return repArray[(trainingDayNumber - 1) % repArray.length];
        }

        // Weight calculations
        function compute1RM(lift, daysElapsed) {
            // For weighted_bodyweight exercises (pullups), goal_bodyweight_multiple represents total load
            // For other exercises, it represents the weight on the bar
            const isWeightedBodyweight = config.sets_reps[lift] && config.sets_reps[lift].type === 'weighted_bodyweight';
            
            const goalWeight = config.targets.goal_bodyweight_multiple[lift] * config.user.bodyweight_lb;
            const startWeight = config.targets.start_as_percentage_of_goal[lift] * goalWeight;
            
            // Linear-log progression based on calendar days
            const t = Math.max(0, Math.min(daysElapsed, 730)); // Clamp at end of Year 2
            const T = 364; // Days 0-364 = 365 days total
            const alpha = config.progression.alpha;
            
            if (T === 0) return goalWeight;
            
            const progressionFactor = Math.log(1 + alpha * t) / Math.log(1 + alpha * T);
            const oneRM = startWeight + (goalWeight - startWeight) * progressionFactor;
            
            // For pullups, oneRM is already total load (no adjustment needed)
            // For barbell lifts, oneRM is the weight on the bar
            return oneRM;
        }

        function computeWorkingWeight(oneRM, reps, isDeload, lift = null) {
            // Epley formula inverted: WorkingWeight = 1RM / (1 + reps/30)
            // For pullups, oneRM includes bodyweight already from compute1RM
            let workingWeight = oneRM / (1 + reps / 30);
            
            // Apply deload to total load (for pullups, this is BW + added weight)
            if (isDeload) {
                workingWeight *= config.progression.deload_factor;
            }
            
            // For pullups, subtract bodyweight to get just the added weight
            // and ensure it doesn't go negative
            if (lift && config.sets_reps[lift] && config.sets_reps[lift].type === 'weighted_bodyweight') {
                workingWeight -= config.user.bodyweight_lb;
                workingWeight = Math.max(0, workingWeight); // Floor at 0 (bodyweight only)
            }
            
            return workingWeight;
        }

        function roundToIncrement(value, increment) {
            return Math.round(value / increment) * increment;
        }

        function plateMath(weightPerSide, plateInventory) {
            const plates = [];
            let remaining = weightPerSide;
            
            // Greedy algorithm: use largest plates first
            for (const plate of plateInventory) {
                while (remaining >= plate - 0.001) { // Small tolerance for floating point
                    plates.push(plate);
                    remaining -= plate;
                }
            }
            
            return plates;
        }

        function getNextTrainingDate(fromDate) {
            const date = parseDate(fromDate);
            date.setDate(date.getDate() + 1);
            
            while (isRestDayISO(formatDateISO(date))) {
                date.setDate(date.getDate() + 1);
            }
            
            return formatDateISO(date);
        }

        function formatDateISO(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Rendering
        function renderLift(lift, trainingDayNumber, date) {
            const cyclePosition = getCyclePosition(trainingDayNumber);
            const daysElapsed = getDaysElapsed(config.user.start_date, date);
            const weekNumber = getWeekNumber(daysElapsed);
            const reps = getRepsForExercise(lift, trainingDayNumber);
            const sets = config.sets_reps[lift].sets;
            const isDeload = isDeloadWeek(daysElapsed);
            
            // Calculate weights
            const oneRM = compute1RM(lift, daysElapsed);
            const workingWeight = computeWorkingWeight(oneRM, reps, isDeload, lift);
            const roundIncrement = config.round_plates_per_side_to_lb[lift];
            
            // For regular lifts, round the total weight
            let totalWeight, weightPerSide, plates;
            
            if (config.sets_reps[lift].type === 'weighted_bodyweight') {
                // For pullups, show total additional weight (not for sides, but total for belt/vest)
                totalWeight = roundToIncrement(workingWeight, roundIncrement);
                // Calculate plate breakdown for the total added weight
                plates = plateMath(totalWeight, config.plate_inventory_per_side_lb);
            } else {
                // For barbell lifts, calculate weight per side after removing bar
                const totalBeforeRounding = workingWeight;
                weightPerSide = (totalBeforeRounding - config.bar_weight_lb) / 2;
                weightPerSide = roundToIncrement(weightPerSide, roundIncrement);
                totalWeight = config.bar_weight_lb + (weightPerSide * 2);
                plates = plateMath(weightPerSide, config.plate_inventory_per_side_lb);
            }
            
            let html = `<div class="lift">`;
            html += `<div class="lift-name">${lift}</div>`;
            html += `<div class="lift-sets-reps">${sets}×${reps}</div>`;
            
            if (config.sets_reps[lift].type === 'weighted_bodyweight') {
                if (totalWeight > 0) {
                    html += `<div class="lift-weight">Add: ${totalWeight % 1 === 0 ? totalWeight : totalWeight.toFixed(2)} lb</div>`;
                    // Show plate breakdown for added weight
                    if (plates.length > 0) {
                        const platesHTML = plates.map(p => {
                            const plateLabel = p >= 1 ? p.toString() : p.toFixed(2);
                            return `<span class="plate-chip">${plateLabel}</span>`;
                        }).join('');
                        html += `<div class="lift-plates">Plates: ${platesHTML}</div>`;
                    }
                } else {
                    html += `<div class="lift-weight">Bodyweight only</div>`;
                }
            } else {
                html += `<div class="lift-weight">Total: ${totalWeight % 1 === 0 ? totalWeight : totalWeight.toFixed(2)} lb</div>`;
                if (plates.length > 0) {
                    const platesHTML = plates.map(p => {
                        const plateLabel = p >= 1 ? p.toString() : p.toFixed(2);
                        return `<span class="plate-chip">${plateLabel}</span>`;
                    }).join('');
                    html += `<div class="lift-plates">Plates/side: ${platesHTML}</div>`;
                } else {
                    html += `<div class="lift-plates">Plates/side: <span class="plate-chip">empty bar</span></div>`;
                }
            }
            
            html += `</div>`;
            
            return html;
        }

        function renderTrainingDay(date, trainingDayNumber, isPreview = false) {
            const cyclePosition = getCyclePosition(trainingDayNumber);
            const cycleDay = config.schedule.cycle[cyclePosition];
            const daysElapsed = getDaysElapsed(config.user.start_date, date);
            const weekNumber = getWeekNumber(daysElapsed);
            const isDeload = isDeloadWeek(daysElapsed);
            
            // Get pattern (A or B)
            const pattern = cycleDay.replace("'", "");
            const lifts = config.schedule.pattern[pattern];
            
            let html = `<div class="day-section${isPreview ? ' preview' : ''}">`;
            html += `<div class="day-header">Week ${weekNumber} • ${formatDate(parseDate(date))}`;
            if (isDeload) {
                html += `<span class="deload-indicator">DELOAD</span>`;
            }
            html += `</div>`;
            
            lifts.forEach(lift => {
                html += renderLift(lift, trainingDayNumber, date);
            });
            
            html += `</div>`;
            return html;
        }

        function renderRestDay(date) {
            const daysElapsed = getDaysElapsed(config.user.start_date, date);
            const weekNumber = getWeekNumber(daysElapsed);
            
            let html = `<div class="day-section">`;
            html += `<div class="day-header">Week ${weekNumber} • ${formatDate(parseDate(date))} • Rest Day</div>`;
            html += `<div class="rest-day">Rest</div>`;
            html += `</div>`;
            
            return html;
        }

        // Motivational statistics table
        function renderStatsTable() {
            const today = formatDateISO(new Date());
            const daysElapsed = getDaysElapsed(config.user.start_date, today);
            
            // Milestone days: 0, 6mo, 12mo, 18mo, 24mo
            const milestones = [
                { label: 'Start', days: 0 },
                { label: '6 Months', days: 182 },
                { label: '12 Months', days: 364 },
                { label: '18 Months', days: 546 },
                { label: '24 Months', days: 730 }
            ];
            
            // Get all lifts
            const lifts = ['Squat', 'Overhead Press', 'Pullup', 'Deadlift', 'Bench', 'Row'];
            const referenceReps = 5; // Hardcoded to 5 reps for stats table
            
            let html = `<div class="stats-table">`;
            html += `<h2>Working Weight @ ${referenceReps} Reps</h2>`;
            html += `<table>`;
            
            // Header row
            html += `<tr><th>Milestone</th>`;
            lifts.forEach(lift => {
                html += `<th>${lift}</th>`;
            });
            html += `</tr>`;
            
            // Data rows
            milestones.forEach(milestone => {
                html += `<tr><td><strong>${milestone.label}</strong></td>`;
                lifts.forEach(lift => {
                    const oneRM = compute1RM(lift, milestone.days);
                    const working = computeWorkingWeight(oneRM, referenceReps, false, lift);
                    const rounded = working % 1 === 0 ? working : working.toFixed(1);
                    html += `<td>${rounded}</td>`;
                });
                html += `</tr>`;
            });
            
            html += `</table>`;
            
            // Percentage increases (if enough time has passed)
            if (daysElapsed >= 30) {
                html += `<h2 style="margin-top: 24px;">Strength Gains</h2>`;
                html += `<table>`;
                html += `<tr><th>Time Period</th>`;
                lifts.forEach(lift => {
                    html += `<th>${lift}</th>`;
                });
                html += `</tr>`;
                
                // 1 month gain (if >= 1 month)
                if (daysElapsed >= 30) {
                    html += `<tr><td><strong>Last 1 Month</strong></td>`;
                    lifts.forEach(lift => {
                        const current = computeWorkingWeight(compute1RM(lift, daysElapsed), referenceReps, false, lift);
                        const previous = computeWorkingWeight(compute1RM(lift, Math.max(0, daysElapsed - 30)), referenceReps, false, lift);
                        const pct = previous > 0 ? ((current - previous) / previous * 100).toFixed(1) : 0;
                        html += `<td><span class="percentage-positive">+${pct}%</span></td>`;
                    });
                    html += `</tr>`;
                }
                
                // 6 month gain (if >= 6 months)
                if (daysElapsed >= 182) {
                    html += `<tr><td><strong>Last 6 Months</strong></td>`;
                    lifts.forEach(lift => {
                        const current = computeWorkingWeight(compute1RM(lift, daysElapsed), referenceReps, false, lift);
                        const previous = computeWorkingWeight(compute1RM(lift, Math.max(0, daysElapsed - 182)), referenceReps, false, lift);
                        const pct = previous > 0 ? ((current - previous) / previous * 100).toFixed(1) : 0;
                        html += `<td><span class="percentage-positive">+${pct}%</span></td>`;
                    });
                    html += `</tr>`;
                }
                
                // 1 year gain (if >= 1 year)
                if (daysElapsed >= 364) {
                    html += `<tr><td><strong>Last 1 Year</strong></td>`;
                    lifts.forEach(lift => {
                        const current = computeWorkingWeight(compute1RM(lift, daysElapsed), referenceReps, false, lift);
                        const previous = computeWorkingWeight(compute1RM(lift, Math.max(0, daysElapsed - 364)), referenceReps, false, lift);
                        const pct = previous > 0 ? ((current - previous) / previous * 100).toFixed(1) : 0;
                        html += `<td><span class="percentage-positive">+${pct}%</span></td>`;
                    });
                    html += `</tr>`;
                }
                
                html += `</table>`;
            }
            
            html += `</div>`;
            return html;
        }

        // Settings UI
        function renderSettings() {
            const isCollapsed = localStorage.getItem(COLLAPSE_KEY);
            // Default to collapsed (true) if never set
            const collapsed = isCollapsed === null ? true : isCollapsed === 'true';
            const errors = validateConfig(workingConfig);
            const errorMap = {};
            errors.forEach(e => errorMap[e.field] = e.message);
            
            const lifts = ['Squat', 'Overhead Press', 'Pullup', 'Deadlift', 'Bench', 'Row'];
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            let html = `<div class="settings-section" id="settings-section">`;
            html += `<div class="settings-header" onclick="toggleSettings()">`;
            html += `Settings <span class="settings-toggle">${collapsed ? '▼' : '▲'}</span>`;
            html += `</div>`;
            html += `<div class="settings-content ${collapsed ? '' : 'open'}" id="settings-content">`;
            
            // User data section
            html += `<div class="settings-group">`;
            html += `<h3>User Data</h3>`;
            
            // Name
            html += `<div class="setting-field">`;
            html += `<label>Name</label>`;
            html += `<input type="text" id="setting-name" value="${workingConfig.user.name || ''}" 
                     class="${errorMap.name ? 'invalid' : ''}" 
                     oninput="updateWorkingConfig('user.name', this.value)">`;
            if (errorMap.name) html += `<div class="setting-error">${errorMap.name}</div>`;
            html += `</div>`;
            
            // Bodyweight
            html += `<div class="setting-field">`;
            html += `<label>Bodyweight (lb)</label>`;
            html += `<input type="number" id="setting-bodyweight" value="${workingConfig.user.bodyweight_lb || ''}" 
                     step="0.1" min="0"
                     class="${errorMap.bodyweight_lb ? 'invalid' : ''}" 
                     oninput="updateWorkingConfig('user.bodyweight_lb', parseFloat(this.value))">`;
            if (errorMap.bodyweight_lb) html += `<div class="setting-error">${errorMap.bodyweight_lb}</div>`;
            html += `</div>`;
            
            // Start date
            html += `<div class="setting-field">`;
            html += `<label>Start Date</label>`;
            html += `<input type="date" id="setting-start-date" value="${workingConfig.user.start_date || ''}" 
                     class="${errorMap.start_date ? 'invalid' : ''}" 
                     oninput="updateWorkingConfig('user.start_date', this.value)">`;
            if (errorMap.start_date) html += `<div class="setting-error">${errorMap.start_date}</div>`;
            html += `</div>`;
            
            html += `</div>`;
            
            // Goals section
            html += `<div class="settings-group">`;
            html += `<h3>Goal Strength (Bodyweight Multiples)</h3>`;
            
            lifts.forEach(lift => {
                const key = lift.replace(' ', '');
                html += `<div class="setting-field">`;
                html += `<label>${lift} <span class="setting-hint">e.g., 1.60 = 1.6× bodyweight</span></label>`;
                html += `<input type="number" id="setting-goal-${key}" 
                         value="${workingConfig.targets.goal_bodyweight_multiple[lift] || ''}" 
                         step="0.01" min="0"
                         class="${errorMap[`goal_${lift}`] ? 'invalid' : ''}" 
                         oninput="updateWorkingConfig('targets.goal_bodyweight_multiple.${lift}', parseFloat(this.value))">`;
                if (errorMap[`goal_${lift}`]) html += `<div class="setting-error">${errorMap[`goal_${lift}`]}</div>`;
                html += `</div>`;
            });
            
            html += `</div>`;
            
            // Start percentages section
            html += `<div class="settings-group">`;
            html += `<h3>Starting Strength (Percentage of Goal)</h3>`;
            
            lifts.forEach(lift => {
                const key = lift.replace(' ', '');
                html += `<div class="setting-field">`;
                html += `<label>${lift} <span class="setting-hint">e.g., 0.60 = 60% of goal</span></label>`;
                html += `<input type="number" id="setting-start-${key}" 
                         value="${workingConfig.targets.start_as_percentage_of_goal[lift] || ''}" 
                         step="0.01" min="0" max="1"
                         class="${errorMap[`start_${lift}`] ? 'invalid' : ''}" 
                         oninput="updateWorkingConfig('targets.start_as_percentage_of_goal.${lift}', parseFloat(this.value))">`;
                if (errorMap[`start_${lift}`]) html += `<div class="setting-error">${errorMap[`start_${lift}`]}</div>`;
                html += `</div>`;
            });
            
            html += `</div>`;
            
            // Rep scheme section
            html += `<div class="settings-group">`;
            html += `<h3>Rep Patterns</h3>`;
            
            lifts.forEach(lift => {
                const key = lift.replace(' ', '');
                const repArray = workingConfig.rep_scheme[lift] || [];
                html += `<div class="setting-field">`;
                html += `<label>${lift} <span class="setting-hint">e.g., '5' for flat or '5,6,5,7' for variation</span></label>`;
                html += `<input type="text" id="setting-reps-${key}" 
                         value="${repArray.join(', ')}" 
                         class="${errorMap[`reps_${lift}`] ? 'invalid' : ''}" 
                         oninput="updateWorkingRepPattern('${lift}', this.value)">`;
                if (errorMap[`reps_${lift}`]) html += `<div class="setting-error">${errorMap[`reps_${lift}`]}</div>`;
                html += `</div>`;
            });
            
            html += `</div>`;
            
            // Training schedule section
            html += `<div class="settings-group">`;
            html += `<h3>Training Schedule</h3>`;
            html += `<div class="checkbox-group">`;
            
            days.forEach(day => {
                const checked = workingConfig.user.training_days.includes(day);
                html += `<div class="checkbox-item">`;
                html += `<input type="checkbox" id="day-${day}" ${checked ? 'checked' : ''} 
                         onchange="updateWorkingTrainingDay('${day}', this.checked)">`;
                html += `<label for="day-${day}">${day}</label>`;
                html += `</div>`;
            });
            
            html += `</div>`;
            if (errorMap.training_days) html += `<div class="setting-error">${errorMap.training_days}</div>`;
            html += `</div>`;
            
            // Plate inventory section
            html += `<div class="settings-group">`;
            html += `<h3>Plate Inventory</h3>`;
            
            html += `<div class="setting-field">`;
            html += `<label>Available Plates per Side (lb) <span class="setting-hint">comma-separated</span></label>`;
            html += `<input type="text" id="setting-plates" 
                     value="${(workingConfig.plate_inventory_per_side_lb || []).join(', ')}" 
                     class="${errorMap.plate_inventory ? 'invalid' : ''}" 
                     oninput="updateWorkingPlateInventory(this.value)">`;
            if (errorMap.plate_inventory) html += `<div class="setting-error">${errorMap.plate_inventory}</div>`;
            html += `</div>`;
            
            html += `</div>`;
            
            // Progression parameters section
            html += `<div class="settings-group">`;
            html += `<h3>Progression Parameters</h3>`;
            
            html += `<div class="setting-field">`;
            html += `<label>Alpha <span class="setting-hint">curvature constant (0.0105 default)</span></label>`;
            html += `<input type="number" id="setting-alpha" 
                     value="${workingConfig.progression.alpha || ''}" 
                     step="0.0001" min="0"
                     class="${errorMap.alpha ? 'invalid' : ''}" 
                     oninput="updateWorkingConfig('progression.alpha', parseFloat(this.value))">`;
            if (errorMap.alpha) html += `<div class="setting-error">${errorMap.alpha}</div>`;
            html += `</div>`;
            
            html += `<div class="setting-field">`;
            html += `<label>Deload Factor <span class="setting-hint">e.g., 0.82 = 82% of normal weight</span></label>`;
            html += `<input type="number" id="setting-deload-factor" 
                     value="${workingConfig.progression.deload_factor || ''}" 
                     step="0.01" min="0" max="1"
                     class="${errorMap.deload_factor ? 'invalid' : ''}" 
                     oninput="updateWorkingConfig('progression.deload_factor', parseFloat(this.value))">`;
            if (errorMap.deload_factor) html += `<div class="setting-error">${errorMap.deload_factor}</div>`;
            html += `</div>`;
            
            html += `</div>`;
            
            // Buttons
            html += `<div class="button-group">`;
            html += `<button class="save-button" onclick="saveSettings()">Save Changes</button>`;
            html += `<button class="reset-button" onclick="resetToDefaults()">Reset to Defaults</button>`;
            html += `</div>`;
            
            html += `</div>`;
            html += `</div>`;
            
            return html;
        }

        // Settings interaction handlers
        function toggleSettings() {
            const content = document.getElementById('settings-content');
            const isOpen = content.classList.contains('open');
            content.classList.toggle('open');
            localStorage.setItem(COLLAPSE_KEY, isOpen.toString());
        }

        function updateWorkingConfig(path, value) {
            const parts = path.split('.');
            let obj = workingConfig;
            for (let i = 0; i < parts.length - 1; i++) {
                obj = obj[parts[i]];
            }
            obj[parts[parts.length - 1]] = value;
        }

        function updateWorkingTrainingDay(day, checked) {
            if (checked) {
                if (!workingConfig.user.training_days.includes(day)) {
                    workingConfig.user.training_days.push(day);
                }
            } else {
                workingConfig.user.training_days = workingConfig.user.training_days.filter(d => d !== day);
            }
        }

        function updateWorkingPlateInventory(value) {
            try {
                const plates = value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
                workingConfig.plate_inventory_per_side_lb = plates;
            } catch (e) {
                // Invalid input, will be caught by validation
            }
        }

        function updateWorkingRepPattern(lift, value) {
            try {
                const reps = value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
                workingConfig.rep_scheme[lift] = reps.length > 0 ? reps : [5]; // Default to [5] if empty
            } catch (e) {
                // Invalid input, will be caught by validation
            }
        }

        function saveSettings() {
            const errors = validateConfig(workingConfig);
            if (errors.length > 0) {
                // Re-render settings to show all validation errors
                const settingsSection = document.getElementById('settings-section');
                if (settingsSection) {
                    settingsSection.outerHTML = renderSettings();
                }
                alert('Please fix validation errors before saving. Check the red fields below.');
                return;
            }
            
            // Copy workingConfig to config
            config = JSON.parse(JSON.stringify(workingConfig));
            saveConfig(config);
            render(); // Full re-render with new config
            
            // Scroll to the stats table to show the updated progression
            setTimeout(() => {
                const statsTable = document.querySelector('.stats-table');
                if (statsTable) {
                    statsTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        function resetToDefaults() {
            if (confirm('Reset all settings to defaults? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                config = getDefaultConfig();
                workingConfig = JSON.parse(JSON.stringify(config));
                saveConfig(config);
                render();
                
                // Scroll to the stats table to show the updated progression
                setTimeout(() => {
                    const statsTable = document.querySelector('.stats-table');
                    if (statsTable) {
                        statsTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        }

        // Main render
        function render() {
            const today = formatDateISO(new Date());
            const app = document.getElementById('app');
            const header = document.getElementById('header');
            
            header.innerHTML = `I Just Wanna Lift <span class="user-name">• ${config.user.name}</span>`;
            
            let html = '';
            
            // Check for validation errors
            const errors = validateConfig(config);
            
            if (errors.length > 0) {
                html += `<div class="error-banner">`;
                html += `⚠️ Please fix configuration errors in Settings below before viewing workouts.`;
                html += `</div>`;
            } else {
                // Only render workout content if config is valid
                if (isRestDayISO(today)) {
                    // Show rest day
                    html += renderRestDay(today);
                    
                    // Show next two training days (both as preview)
                    let nextDate = getNextTrainingDate(today);
                    let nextTrainingDay = getTrainingDayNumber(config.user.start_date, nextDate);
                    html += renderTrainingDay(nextDate, nextTrainingDay, true);
                    
                    nextDate = getNextTrainingDate(nextDate);
                    nextTrainingDay = getTrainingDayNumber(config.user.start_date, nextDate);
                    html += renderTrainingDay(nextDate, nextTrainingDay, true);
                } else {
                    // Show today (training day)
                    const todayTrainingDay = getTrainingDayNumber(config.user.start_date, today);
                    html += renderTrainingDay(today, todayTrainingDay, false);
                    
                    // Show next training day (as preview)
                    const nextDate = getNextTrainingDate(today);
                    const nextTrainingDay = getTrainingDayNumber(config.user.start_date, nextDate);
                    html += renderTrainingDay(nextDate, nextTrainingDay, true);
                }
                
                // Add stats table at the bottom
                html += renderStatsTable();
            }
            
            // Always show settings at the bottom
            html += renderSettings();
            
            // Add footer
            html += `<div class="footer">`;
            html += `Learn more at <a href="https://github.com/thanthese/IJustWannaLift" target="_blank">github.com/thanthese/IJustWannaLift</a>`;
            html += `</div>`;
            
            app.innerHTML = html;
        }

        // Initialize
        render();
    </script>
</body>
</html>
